<%= render 'shared/loading_spinner' %>

<div class="game-page">
  <div class="game-container">

    <!-- Sidebar : Info personnage + sc√©nario -->
    <aside class="game-sidebar">
      <div class="sidebar-section">
        <h3 class="sidebar-title">
          <span class="title-icon">‚öîÔ∏è</span> Personnage
        </h3>
        <div class="character-info">
          <h4 class="char-name"><%= @character.name %></h4>
          <p class="char-class"><%= @character.class_type.upcase %></p>

          <div class="char-stats">
            <div class="stat-row">
              <span class="stat-icon">‚ù§Ô∏è</span>
              <span class="stat-label">PV</span>
              <span class="stat-bar">
                <span class="stat-fill" style="width: 100%"></span>
              </span>
              <span class="stat-value"><%= @character.health %></span>
            </div>

            <div class="stat-row">
              <span class="stat-icon">‚ú®</span>
              <span class="stat-label">Mana</span>
              <span class="stat-bar">
                <span class="stat-fill stat-fill-mana" style="width: 100%"></span>
              </span>
              <span class="stat-value"><%= @character.mana %></span>
            </div>

            <div class="stat-row">
              <span class="stat-icon">‚öîÔ∏è</span>
              <span class="stat-label">Force</span>
              <span class="stat-value"><%= @character.strength %></span>
            </div>
          </div>
        </div>
      </div>

      <div class="sidebar-section">
        <h3 class="sidebar-title">
          <span class="title-icon">üìú</span> Sc√©nario
        </h3>
        <div class="scenario-info">
          <h4 class="scenario-name"><%= @scenario.title %></h4>
        </div>
      </div>

      <div class="sidebar-section">
        <%= link_to root_path, class: "btn-quit" do %>
          üö™ Quitter la partie
        <% end %>
      </div>
    </aside>

    <!-- Zone principale : Messages + Input -->
    <main class="game-main">
<!-- Messages -->
<div class="messages-container" id="messagesContainer">
  <% @messages.each do |message| %>
    <div class="message message-<%= message.role %>
         <%= 'message-new' if message.id == session[:new_message_id] %>"
         data-message-id="<%= message.id %>">
      <div class="message-header">
        <span class="message-author">
          <%= message.role == 'user' ? 'üéÆ' + ' ' + current_user.email.split('@').first.upcase : 'üé≤ Ma√Ætre du Jeu' %>
        </span>
        <span class="message-time">
          <%= message.created_at.strftime('%H:%M') %>
        </span>
      </div>
      <div class="message-content"
           <% if message.id == session[:new_message_id] %>
             data-typewriter="<%= message.content %>"
           <% end %>>
        <% if message.id == session[:new_message_id] %>
          <!-- Le texte sera ajout√© par JS -->
        <% else %>
          <%= simple_format(message.content) %>
        <% end %>
      </div>
    </div>
  <% end %>

  <%= render 'shared/chat_spinner' %>
</div>

<!-- Input zone -->
<!-- Input zone -->
<div class="input-zone">
  <form action="<%= player_action_game_path(@game) %>"
        method="post"
        class="action-form"
        accept-charset="UTF-8"
        onsubmit="showSpinnerAndScroll(); return true;">

    <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">

    <textarea
      name="action_text"
      id="action_text"
      placeholder="Que faites-vous ? (Ex: J'explore la pi√®ce, j'attaque le gobelin...)"
      class="action-input"
      rows="3"
      required></textarea>

    <button type="submit" class="btn-send-action">‚û§ Envoyer</button>
  </form>
</div>

<script>
  // Fonction pour afficher le spinner ET scroller
  function showSpinnerAndScroll() {
    const spinner = document.getElementById('chatSpinner');
    const container = document.getElementById('messagesContainer');

    if (spinner) {
      spinner.style.display = 'flex';
    }

    if (container) {
      setTimeout(function() {
        container.scrollTop = container.scrollHeight;
      }, 10);
    }

    return true;
  }

  // Effet typewriter
  function typewriter(element, text, speed = 30) {
    let index = 0;
    element.textContent = '';

    function type() {
      if (index < text.length) {
        element.textContent += text.charAt(index);
        index++;

        // Auto-scroll pendant l'animation
        const container = document.getElementById('messagesContainer');
        if (container) {
          container.scrollTop = container.scrollHeight;
        }

        setTimeout(type, speed);
      }
    }

    type();
  }

  // Auto-scroll et typewriter au chargement
  (function() {
    function scrollToBottom() {
      const container = document.getElementById('messagesContainer');
      if (container) {
        container.scrollTop = container.scrollHeight;
      }
    }

    // Lancer l'effet typewriter sur le nouveau message
    const newMessage = document.querySelector('[data-typewriter]');
    if (newMessage) {
      const text = newMessage.getAttribute('data-typewriter');
      const contentDiv = newMessage;
      typewriter(contentDiv, text, 10); // 30ms entre chaque caract√®re
    }

    scrollToBottom();
    document.addEventListener('DOMContentLoaded', scrollToBottom);
    window.addEventListener('load', scrollToBottom);
    setTimeout(scrollToBottom, 100);
  })();

  setTimeout(function() {
    <% session.delete(:new_message_id) %>
  }, 100);
</script>
